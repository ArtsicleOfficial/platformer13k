<html><body style="background-color:black;user-select: none" oncontextmenu="return false;"><center><canvas id="game" width="800" height="600" style="background-color:aliceblue"></canvas><p style="color:white">Press P to add a new player. (Max of 2, first player uses arrow keys, second uses WASD. Second player optional.)</p></center><script>
players = []
objects = []
particles = []
subparticles = []
canvas = document.getElementById("game");
ctx = canvas.getContext("2d");
function createObject(x,y,w,h,collidable,color,onTouch) {
	if(onTouch != undefined) {
		objects.push({x,y,w,h,collidable,color,onTouch})
	} else {
		objects.push({x,y,w,h,collidable,color})
	}
	return objects[objects.length-1]
}
function uncollidableObject(x,y,w,h) {
	createObject(x,y,w,h,false,"100,100,100")
}
function object(x,y,w,h) {
	createObject(x,y,w,h,true,"0,0,0")
}

function cobjects(objects) {
	for(var o in objects) {
		var obj = objects[o];
		createObject(obj[0],obj[1],obj[2],obj[3],true,"0,0,0")
	}
}

function uncollidableObjects(objects) {
	for(var o in objects) {
		var obj = objects[o];
		createObject(obj[0],obj[1],obj[2],obj[3],false,"100,100,100")
	}
}
function createPlayer(x,y,w,h,collidable,color,controls,speed,id) {
	players.push({x,y,w,h,collidable,color,controls,gravity:0,move:{l:false,r:false},speed,id:id})
	return players[players.length-1]
}
function createParticle(x,y,color,size,amount,spreadX,speedY,life) {
	particles.push({x,y,color,size,amount,spreadX,speedY,did:0,life});
	log(particles[particles.length-1])
	return particles[particles.length-1]
}
function createSubParticle(parent) {
	subparticles.push({x:parent.x,y:parent.y,life:0,parent});
	return subparticles[particles.length-1]
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION*/
function log(string) {
	console.log(string);
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION!*/
window.addEventListener("keydown",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=true;
			break;
		case plr.controls.l:
			plr.move.l=true;
			break;
		case plr.controls.u:
			if(playerInGround(plr)==true){plr.gravity=-5};
			break;
		}
	}
	if(k.keyCode==80) {
		var p = players[0];
		if(players.length < 2) {
			createPlayer(0,-550,p.w,p.h,p.collidable,p.color,{u:87,l:65,r:68},2,"2");
		}
	}
})
window.addEventListener("keyup",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=false;
			break;
		case plr.controls.l:
			plr.move.l=false;
		}
	}
})

/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
/*var vec1;
var vec2;*/
//var created = [];
canvas.addEventListener("mousedown",function(k) {
	plr = players[0]
	var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
	var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
	if(k.button == 2) {
		plr.x = x;
		plr.y = y;
		//t=!t;
		//log(t);
	} else {
		//vec1={x,y};
	}
})
//var t = false;
/*canvas.addEventListener("mouseup",function(k) {
	if(k.button == 0) {
		var plr = players[0];
		var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
		var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
		vec2={x:x-vec1.x,y:y-vec1.y};
		var obj = "[" + (vec1.x) + "," + (vec1.y) + "," + (vec2.x) + "," + (vec2.y) + "]";

		if(t) {
			createObject(vec1.x,vec1.y,vec2.x,vec2.y,false,"100,100,100")
		} else {
			createObject(vec1.x,vec1.y,vec2.x,vec2.y,true,"0,0,0")
		}
		created.push(obj);
		var createdStr = "";
		for(var i in created) {
			createdStr+=created[i] + "\n";
		}
		log(createdStr);
		createObject(vec1.x,vec1.y,vec2.x,vec2.y,true,"0,0,0")
	}
})*/
/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
function playerInGround(plr) {
	plr.y+=1;
	if(collide(plr)) {
		plr.y-=1;
		return true;
	}
	return false;
}
function getPlayerOffset(posX,posY) {
	var plr = players[0];
	return {x:Math.floor(posX-plr.x+(800/2-(plr.w/2))),y:Math.floor(posY-plr.y)+400};
}
function getPlayerPos() {
	return {x:Math.floor((800/2)-(plr.w/2)),y:400};
}
function drawObjects(collidable) {
	for(var o in objects) {
		var obj = objects[o];
		if(obj.collidable == collidable) {
			var obj = objects[o];
			ctx.fillStyle = "rgb(" + obj.color + ")";
			var plr = players[0]
			var position = getPlayerOffset(obj.x,obj.y);
			var x = position.x;
			var y = position.y;
			if(onScreen(x,y,obj.w,obj.h)) {
				ctx.fillRect(x,y,obj.w,obj.h);
			}
		}
	}
}
function indicator(id,posX,posY,off,pointX,pointY) {
		ctx.save();
		ctx.beginPath();
		ctx.font = "15px Verdana";
		ctx.textAlign = "center";
		if(pointX != undefined && pointY != undefined) {
			ctx.save();
			ctx.transform(0,1,1,0,posX+10,posY-off-15);
			ctx.rotate(Math.atan2(posX-pointX,posY-pointY))
			/*ctx.moveTo(0,0-15);
			ctx.lineTo(0+10,0-15);
			ctx.lineTo(0+5,0-5);*/
			
			ctx.moveTo(0,0);
			ctx.lineTo(15,5);
			ctx.lineTo(15,-5)
			ctx.restore();
			//ctx.fillRect(0,0,20,3);
		} else {
			ctx.moveTo(posX,posY-15-off);
			ctx.lineTo(posX+10,posY-15-off);
			ctx.lineTo(posX+5,posY-5-off);
			ctx.fillStyle = "rgb(0,100,0)"
			ctx.fillText(id,posX+5,posY-20-off)
		}
		ctx.lineWidth=2;
		var clr = "rgb(120,180,140)";
		ctx.strokeStyle=clr;
		ctx.fillStyle=clr;
		ctx.fill();
		ctx.stroke();
		ctx.restore();
		//ctx.lineTo(posX+2,posY-5);
		ctx.closePath();
}
function minMax(num,min,max) {
	if(num <= min) num=min;
	if(num >= max) num=max;
	return num;
}
function minOrMax(num,min,max) {
	if(num <= max/2) {
		num=min
	} else {
		num=max;
	}
	return num;
}
function drawPlayers() {
	if(players.length != 0) {
		var off = offset/10;
		var plr = players[0]
		ctx.fillStyle = "rgb(" + plr.color + ")";
		var posX = 800/2-(plr.w/2);
		var posY = 400
		ctx.fillRect(posX,posY,plr.w,plr.h);
		if(players.length > 1) {
			indicator(plr.id,posX,posY,off);
		}
		for(var p in players) {
			if(p != 0) {
				var pl = players[p];
				ctx.fillStyle = plr.color;
				var position = getPlayerOffset(pl.x,pl.y);
				var posX = position.x;
				var posY = position.y;
				ctx.fillRect(posX,posY,pl.w,pl.h);
				if(onScreen(posX,posY,pl.w,pl.h)) {
					indicator(pl.id,posX,posY,off,"down")
				} else {
					posX = minMax(posX,10,790);
					posY = minMax(posY,10,590);
					indicator(pl.id,posX,posY,off,position.x,position.y)
				}
			}
		}
	}
}
var sa = false;
function createObjects() {
	cobjects([[220,270,150,10],[210,220,10,50],[190,170,10,50],[200,220,10,10],[370,240,10,30],[380,190,10,40],[370,230,10,10],[320,180,60,10],[310,140,10,40],[220,230,10,10],[180,120,10,40],[170,160,10,10],[180,170,10,10],[320,90,10,50],[280,80,40,10],[240,170,20,20],[170,90,10,30],[100,80,60,10],[170,80,10,10],[160,70,10,10],[270,40,10,40],[230,30,30,10],[260,20,10,10],[270,30,10,10],[190,20,40,10],[130,10,60,10],[80,20,50,10],[30,90,60,10],[90,80,10,10],[20,30,60,10],[-10,80,40,10],[-40,20,60,10],[-30,90,20,10],[-50,10,10,10],[-40,-30,10,40],[-30,-100,10,70],[-20,-140,10,30],[-20,-110,10,10],[-10,-180,10,40],[0,-190,10,10],[10,-200,10,10],[20,-210,30,10],[60,-220,50,10],[50,-220,10,10],[120,-230,170,10],[110,-230,10,10],[-50,100,20,10],[-200,110,150,10],[-390,120,190,10],[-1150,150,170,10],[-1090,100,10,50],[-1080,90,10,10],[-1090,80,10,10],[-1100,70,10,10],[-1120,60,20,10],[-1130,70,10,10],[-1140,80,10,10],[-1150,90,10,10],[-1120,130,20,20],[-1130,110,10,10],[-1100,110,10,10],[-1140,90,60,10],[-1140,100,10,50],[-1330,160,180,10],[-1080,130,10,10],[-1150,130,10,10],[-1580,170,250,10],[-980,160,10,20],[-970,180,10,20],[-960,200,10,40],[-950,240,20,10],[-930,260,10,60],[-930,250,10,10],[-920,320,10,80],[-910,400,10,10],[-900,410,10,20],[-890,430,20,10],[-870,440,10,10],[-860,450,50,10],[-810,460,50,10],[-760,470,10,10],[-740,480,110,10],[-750,480,10,10],[-630,470,100,10],[-530,460,50,10],[-480,450,40,10],[-440,390,10,60],[-430,280,10,100],[-440,380,10,10],[-420,180,10,100],[-410,160,10,20],[-400,130,10,20],[-400,150,10,10],[-910,380,10,10],[-910,330,10,10],[-920,310,10,10],[-890,260,10,30],[-880,290,10,10],[-880,280,10,10],[-900,270,10,10],[-930,240,10,10],[-920,240,10,10],[-910,250,10,10],[-900,260,10,10],[-880,270,10,10],[-870,270,10,20],[-450,240,30,10],[-490,250,40,10],[-500,240,10,30],[-510,250,10,30],[-520,280,10,10],[-530,260,10,20],[-520,250,10,30],[-660,330,50,10],[-610,340,50,10],[-800,330,30,10],[-550,360,10,20],[-540,410,10,10],[-1760,180,180,10],[-2040,170,40,10],[-2080,150,40,10],[-2050,160,10,10],[-2090,100,10,50],[-2100,-10,10,110],[-2110,-50,10,40],[-1850,190,10,10],[-1860,200,10,20],[-1870,220,10,30],[-1880,240,10,10],[-1910,360,10,20],[-1900,380,30,10],[-1870,390,60,10],[-1810,400,50,10],[-1760,390,40,10],[-1720,380,20,10],[-1700,360,10,20],[-1690,330,10,30],[-1680,290,10,30],[-1680,320,10,10],[-1690,260,10,30],[-1700,240,10,20],[-1720,230,20,10],[-1740,220,20,10],[-1750,210,10,10],[-1760,190,10,20],[-1910,290,10,10],[-1900,270,10,20],[-1890,250,10,20],[-2090,300,180,10],[-2090,360,180,10],[-2200,360,100,10],[-2120,370,20,30],[-2090,370,20,30],[-2080,400,10,20],[-2230,420,150,10],[-2080,420,10,10],[-2510,-130,10,500],[-2500,160,10,10],[-2500,120,10,10],[-2500,80,10,10],[-2500,40,10,10],[-2500,0,10,10],[-2500,-40,10,10],[-2500,-80,10,10],[-2500,-120,10,10],[-2510,-180,10,50],[-2500,-190,120,10],[-2380,-200,90,10],[-2280,-200,60,10],[-2290,-210,10,10],[-2220,-190,50,10],[-2000,180,160,10],[-2210,180,210,10],[-2340,160,70,10],[-2360,150,20,10],[-2370,130,10,20],[-2380,70,10,60],[-2390,-100,10,170],[-2400,-60,10,10],[-2400,-100,10,10],[-2100,-100,40,10],[-2060,-90,30,10],[-2030,-80,10,10],[-2020,-70,10,30],[-2010,-40,10,50],[-2270,300,10,10],[-2240,330,10,10],[-2270,170,10,10],[-2220,170,10,10],[-2230,180,10,20],[-2260,180,10,10],[-2270,150,10,10],[-2260,140,30,10],[-2230,150,10,10],[-2220,160,10,10],[-2380,-100,280,10],[-2110,-80,10,30],[-2110,-90,10,10],[-2360,140,10,10],[-2500,210,130,10],[-2380,220,10,20],[-2330,250,10,30],[-2330,280,50,10],[-2290,290,10,20],[-2380,240,60,10],[-2280,310,50,10],[-2290,310,10,10],[-2240,320,10,10],[-2240,340,40,10],[-2210,350,10,20],[-2500,360,290,10],[-2240,300,10,10],[-2230,310,10,20],[-2280,210,10,10],[-2250,200,10,10]]);
	uncollidableObjects([[240,180,10,90],[200,190,60,10],[290,90,10,50],[280,140,10,60],[270,200,10,40],[260,240,10,30],[270,150,40,10],[220,140,50,10],[190,130,30,10],[150,20,10,60],[100,30,10,50],[40,40,10,50],[70,40,10,50],[0,30,10,50],[-1130,110,40,40],[-1130,100,40,10],[-1130,80,40,10],[-1120,70,20,10],[-1080,100,10,10],[-1150,100,10,10],[-260,100,10,20],[-250,90,10,10],[-320,110,10,10],[-240,110,30,10],[-250,100,10,10],[-230,100,20,10],[-210,100,10,10],[-200,90,20,10],[-190,100,10,10],[-170,90,30,10],[-180,100,10,10],[-160,100,20,10],[-150,80,10,10],[-140,90,20,10],[-130,100,10,10],[-120,100,10,10],[-90,100,10,10],[-350,110,10,10],[-360,100,10,10],[-340,100,10,10],[-330,90,10,10],[-320,90,10,10],[-330,100,20,10],[-330,110,10,10],[-840,430,20,20],[-830,380,20,50],[-820,350,40,30],[-800,340,40,10],[-770,330,110,10],[-680,340,70,10],[-620,350,60,10],[-540,420,10,50],[-750,470,120,10],[-810,380,40,80],[-820,430,10,20],[-770,350,10,110],[-780,350,10,30],[-760,340,80,60],[-680,350,60,10],[-760,400,210,70],[-550,440,10,30],[-420,150,20,10],[-680,360,130,40],[-550,380,10,50],[-550,430,10,10],[-1790,350,10,50],[-1780,250,10,100],[-1770,180,10,60],[-1770,240,10,10],[-1760,160,10,20],[-1940,310,10,50],[-1950,310,30,10],[-1990,320,10,40],[-2000,310,30,10],[-2050,310,30,10],[-2040,320,10,40],[-2100,310,30,10],[-2090,320,10,40],[-1950,290,30,10],[-1940,200,10,90],[-1950,190,30,10],[-2000,190,30,10],[-1990,200,10,90],[-2000,290,30,10],[-2050,290,30,10],[-2040,200,10,90],[-2050,190,30,10],[-2100,290,30,20],[-2090,200,10,90],[-2100,190,30,10],[-2180,320,10,40],[-2190,250,10,70],[-2200,200,10,50],[-2210,190,30,10],[-2190,350,30,10],[-2310,250,10,30],[-2300,230,10,20],[-2290,220,20,10],[-2260,210,60,10],[-2270,210,10,10],[-2320,270,30,10],[-2490,160,150,10],[-2490,120,110,10],[-2490,80,110,10],[-2490,40,100,10],[-2490,0,100,10],[-2490,-40,100,10],[-2490,-80,100,10],[-2500,-60,100,10],[-2500,-100,100,10],[-2490,-120,100,10],[-2390,-110,50,10],[-2320,-190,20,10],[-2310,-180,10,70],[-2310,-110,10,10],[-2230,-180,20,10],[-2230,-190,10,10],[-2230,-170,10,20],[-2240,-150,10,40],[-2250,-110,10,10]])

	createPlayer(294,170,10,20,true,"0,0,0",{l:37,u:38,r:39},2,"1");
}

function calculateGravity(g) {
	return g+(10/60);
}
function isColliding(x,y,w,h,x2,y2,w2,h2) {
	return (x+w> x2 && x < x2+w2 && y+h > y2 && y < y2+h2)
}
function onScreen(x,y,w,h) {
	if(x+w>=0 && x <= 800 && y+h >= 0 && y <= 600) {
		return true
	}
	return false
}
function collide(plr) {
	for(var o in objects) {
		var obj = objects[o];
		if(plr.collidable) {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable == true) {
				if(obj.onTouch != undefined) {
					obj.onTouch();
				}
				return true;
			}
		} else {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable != true) {
				return true;
			}
		}
	}
	for(var p in players) {
		var pl = players[p];
		if(plr.id !== pl.id) {
			if(plr.collidable) {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable == true) {
					return true;
				}
			} else {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable != true) {
					return true;
				}
			}
		}
	}
	return false;
}
var offset = 25;
var up = true;
function logicPlayers() {
	if(up) {
		offset++;
	} else {
		offset--;
	}
	if(offset >= 50) {
		up = false;
	}
	if(offset <= 0) {
		up = true;
	}
	for(let p in players) {
		var plr = players[p];
		plr.gravity=calculateGravity(plr.gravity);
		plr.y+=plr.gravity
		if(plr.gravity >= 40) {
			location.reload();
		}
		if(collide(plr)==true) {
			plr.y-=plr.gravity
			plr.gravity = 0
		}
		if(plr.move.r) {
			plr.x+=plr.speed;
			if(collide(plr)==true) {
				plr.x-=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x+=i;
					if(collide(plr)==true)plr.x-=i;
				}
			}
		}
		if(plr.move.l) {
			plr.x-=plr.speed;
			if(collide(plr)==true) {
				plr.x+=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x-=i;
					if(collide(plr)==true)plr.x+=i;
				}
			}
		}

	}
}
var tick = 0;
function randInt(min,max) {
	return Math.random() * (max - min) + min;
}
function clearGame() {
	for(var i in particles) {
		delete particles[i];
	}
	for(var i in objects) {
		delete objects[i];
	}
	for(var i in players) {
		delete players[i];
	}
}
function logicParticles() {
	for(var p in particles) {
		var particle = particles[p];
		var amtsixth = particle.amount/60;
		particle.did++;
		if(amtsixth*particle.did >= 1) {
			particle.did = 0;
			createSubParticle(particle);
		}
		if(tick == 60) {
			particle.did = 0;
		}
	}
	for(var sp in subparticles) {
		var subparticle = subparticles[sp]
		subparticle.life++;
		if(subparticle.life > subparticle.parent.life) {
			delete subparticles[sp];
		}
		subparticle.y+=subparticle.parent.speedY;
		subparticle.x+=randInt(-subparticle.parent.spreadX,subparticle.parent.spreadX);
	}

}
function drawParticles() {
	for(var sp in subparticles) {
		var pos;
		var subparticle = subparticles[sp];
		if(players.length == 0) {
			pos = {x:subparticle.x,y:subparticle.y}
		} else {
			pos = getPlayerOffset(subparticle.x,subparticle.y);
		}
		ctx.fillStyle = "rgb("+subparticle.parent.color+")";
		if(onScreen(pos.x,pos.y,subparticle.parent.size,subparticle.parent.size)) {
			ctx.fillRect(pos.x,pos.y,subparticle.parent.size,subparticle.parent.size);
		}
	}
}
var screen = 0;
ctx.textAlign = "center"
function loop() {
	window.requestAnimFrame(function() {
		loop();
	});

	logicPlayers();
	logicParticles();

	tick++;
	if(tick > 60) {
		tick =0;
	}
	ctx.clearRect(0,0,800,600);
	drawObjects(false);
	drawParticles();
	drawObjects(true);
	drawPlayers();
	if(screen == 0) {
		//Had to hardcode this, if I had the filesize to spare i'd add a new text object
		ctx.font = "40px Verdana";
		ctx.fillStyle = "black";
		ctx.fillText("Click to play",800/2,600/2)
	}
}

window.requestAnimFrame = (function() {
	return window.requestAnimationFrame ||
		   window.webkitRequestAnimationFrame ||
		   window.oRequestAnimationFrame ||
		   window.setTimeout(function(callback){},1000/60);
})();
titleParticle = createParticle(5,5,"0,0,100",7,60,5,-3,50)
canvas.addEventListener("mousemove",function(e) {
	if(screen == 0) {
		if(titleParticle != undefined) {
			titleParticle.x = e.clientX-canvas.offsetLeft
			titleParticle.y = e.clientY-canvas.offsetTop
		}
	}
})
canvas.addEventListener("mousedown",function(e) {
	if(screen == 0) {
		screen = 1;
		clearGame();
		createObjects();
	}
})
//createObjects();

loop();
</script></body>
</html>