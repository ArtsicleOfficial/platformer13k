<html><body style="background-color:black;user-select: none" oncontextmenu="return false;"><center><canvas id="game" width="800" height="600" style="background-color:aliceblue"></canvas><p style="color:white">Press P to add a new player. (Max of 2, first player uses arrow keys, second uses WASD. Second player optional.)</p></center><script>
players = []
objects = []
particles = []
subparticles = []
canvas = document.getElementById("game");
ctx = canvas.getContext("2d");
function createObject(x,y,w,h,collidable,color,onTouch) {
	if(onTouch != undefined) {
		objects.push({x,y,w,h,collidable,color,onTouch})
	} else {
		objects.push({x,y,w,h,collidable,color})
	}
	return objects[objects.length-1]
}
function uncollidableObject(x,y,w,h) {
	createObject(x,y,w,h,false,"100,100,100")
}
function object(x,y,w,h) {
	createObject(x,y,w,h,true,"0,0,0")
}

function cobjects(objects) {
	for(var o in objects) {
		var obj = objects[o];
		createObject(obj[0],obj[1],obj[2],obj[3],true,"0,0,0")
	}
}

function uncollidableObjects(objects) {
	for(var o in objects) {
		var obj = objects[o];
		createObject(obj[0],obj[1],obj[2],obj[3],false,"100,100,100")
	}
}
function createPlayer(x,y,w,h,collidable,color,controls,speed,id) {
	players.push({x,y,w,h,collidable,color,controls,gravity:0,move:{l:false,r:false},speed,id:id})
	return players[players.length-1]
}
function createParticle(x,y,color,size,amount,spreadX,speedY,life) {
	particles.push({x,y,color,size,amount,spreadX,speedY,did:0,life});
	return particles[particles.length-1]
}
function createSubParticle(parent) {
	subparticles.push({x:parent.x,y:parent.y,life:0,parent});
	return subparticles[particles.length-1]
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION*/
function log(string) {
	console.log(string);
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION!*/
window.addEventListener("keydown",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=true;
			break;
		case plr.controls.l:
			plr.move.l=true;
			break;
		case plr.controls.u:
			if(playerInGround(plr)==true){plr.gravity=-5};
			break;
		}
	}
	if(k.keyCode==80) {
		var p = players[0];
		if(players.length < 2) {
			createPlayer(0,-550,p.w,p.h,p.collidable,p.color,{u:87,l:65,r:68},2,"2");
		}
	}
})
window.addEventListener("keyup",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=false;
			break;
		case plr.controls.l:
			plr.move.l=false;
		}
	}
})

/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
var vec1;
var vec2;
var created = [];
canvas.addEventListener("mousedown",function(k) {
	plr = players[0]
	var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
	var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
	if(k.button == 2) {
		plr.x = x;
		plr.y = y;
		t=!t;
		log(t);
	} else {
		vec1={x,y};
	}
})
var t = false;
canvas.addEventListener("mouseup",function(k) {
	if(k.button == 0) {
		var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
		var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
		vec2={x:x-vec1.x,y:y-vec1.y};
		var obj = "[" + (vec1.x) + "," + (vec1.y) + "," + (vec2.x) + "," + (vec2.y) + "]";

		if(t) {
			createObject(vec1.x,vec1.y,vec2.x,vec2.y,false,"100,100,100")
		} else {
			createObject(vec1.x,vec1.y,vec2.x,vec2.y,true,"0,0,0")
		}
		created.push(obj);
		var createdStr = "";
		for(var i in created) {
			createdStr+=created[i] + "\n";
		}
		log(createdStr);
		createObject(vec1.x,vec1.y,vec2.x,vec2.y,true,"0,0,0")
	}
})
/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
function playerInGround(plr) {
	plr.y+=1;
	if(collide(plr)) {
		plr.y-=1;
		return true;
	}
	return false;
}
function getPlayerOffset(posX,posY) {
	var plr = players[0];
	return {x:Math.round(posX-plr.x+(800/2-(plr.w/2))),y:Math.round(posY-plr.y)+400};
}
function getPlayerPos() {
	return {x:Math.round((800/2)-(plr.w/2)),y:400};
}
function drawObjects(collidable) {
	for(var o in objects) {
		var obj = objects[o];
		if(obj.collidable == collidable) {
			var obj = objects[o];
			ctx.fillStyle = "rgb(" + obj.color + ")";
			var plr = players[0]
			var position = getPlayerOffset(obj.x,obj.y);
			var x = position.x;
			var y = position.y;
			if(onScreen(x,y,obj.w,obj.h)) {
				ctx.fillRect(x,y,obj.w,obj.h);
			}
		}
	}
}
function indicator(id,posX,posY,off,pointX,pointY) {
		ctx.save();
		ctx.beginPath();
		
		if(pointX != undefined && pointY != undefined) {
			ctx.save();
			ctx.transform(0,1,1,0,posX+10,posY-off-15);
			ctx.rotate(Math.atan2(posX-pointX,posY-pointY))
			/*ctx.moveTo(0,0-15);
			ctx.lineTo(0+10,0-15);
			ctx.lineTo(0+5,0-5);*/
			
			ctx.moveTo(0,0);
			ctx.lineTo(15,5);
			ctx.lineTo(15,-5)
			ctx.restore();
			//ctx.fillRect(0,0,20,3);
		} else {
			ctx.moveTo(posX,posY-15-off);
			ctx.lineTo(posX+10,posY-15-off);
			ctx.lineTo(posX+5,posY-5-off);
			ctx.fillStyle = "rgb(0,100,0)"
			ctx.fillText(id,posX+3,posY-20-off)
		}
		ctx.lineWidth=2;
		var clr = "rgb(120,180,140)";
		ctx.strokeStyle=clr;
		ctx.fillStyle=clr;
		ctx.fill();
		ctx.stroke();
		ctx.restore();
		//ctx.lineTo(posX+2,posY-5);
		ctx.closePath();
}
function minMax(num,min,max) {
	if(num <= min) num=min;
	if(num >= max) num=max;
	return num;
}
function minOrMax(num,min,max) {
	if(num <= max/2) {
		num=min
	} else {
		num=max;
	}
	return num;
}
function drawPlayers() {
	var off = offset/10;
	var plr = players[0]
	ctx.fillStyle = "rgb(" + plr.color + ")";
	var posX = 800/2-(plr.w/2);
	var posY = 400
	ctx.fillRect(posX,posY,plr.w,plr.h);
	if(players.length > 1) {
		indicator(plr.id,posX,posY,off);
	}
	for(var p in players) {
		if(p != 0) {
			var pl = players[p];
			ctx.fillStyle = plr.color;
			var position = getPlayerOffset(pl.x,pl.y);
			var posX = position.x;
			var posY = position.y;
			ctx.fillRect(posX,posY,pl.w,pl.h);
			if(onScreen(posX,posY,pl.w,pl.h)) {
				indicator(pl.id,posX,posY,off,"down")
			} else {
				posX = minMax(posX,10,790);
				posY = minMax(posY,10,590);
				indicator(pl.id,posX,posY,off,position.x,position.y)
			}
		}
	}
}
function createObjects() {
	cobjects([[-280,150,70,420],[210,440,410,130],[200,370,120,200],[370,350,40,10],[420,310,40,10],[550,310,40,10],[580,260,30,10],[580,200,20,10],[320,520,710,50],[320,400,30,155],[350,430,30,125],[380,460,30,110],[410,490,30,75],[440,520,30,50],[580,140,30,10],[640,40,280,20],[620,40,20,20],[620,120,20,450],[660,-70,30,120],[740,-70,30,120],[820,-70,30,120],[640,490,300,10],[680,440,40,50],[780,440,60,50],[870,460,20,30],[740,340,260,10],[640,120,10,370],[660,90,190,10],[650,130,10,10],[650,200,10,10],[650,270,10,10],[650,340,10,10],[650,410,10,10],[990,490,40,30],[990,450,10,40],[1000,450,30,20],[1020,470,10,20],[1000,420,20,30],[-280,510,530,60],[190,370,10,10],[190,430,10,10],[190,490,10,10],[1030,270,20,300],[940,480,20,30],[920,510,60,10],[960,490,30,20],[1070,220,30,40],[1170,220,20,40],[1280,220,30,40],[1410,220,40,30],[920,40,20,150],[940,170,120,10],[940,180,120,10],[1450,90,120,290],[1030,370,660,10],[1050,270,10,10],[1050,330,10,10], [-470,550,200,20],[-470,150,10,420],[-470,150,190,10],[-290,200,10,10],[780,90,10,250],[1380,140,10,10],[1330,80,10,10],[1090,130,10,10],[1160,80,10,10],[1240,40,10,10],[1440,170,10,10],[1440,110,10,10],[1570,150,10,10],[1570,210,10,10],[1570,270,10,10],[1570,320,10,10],[1570,90,10,10],[1790,360,110,10],[1910,360,30,10],[1960,360,20,10],[2010,360,20,10],[2030,110,10,260],[1960,110,20,10],[2010,110,20,10],[1850,110,110,10],[1890,370,10,360],[1910,370,10,360],[1930,370,10,360],[1960,370,10,360],[1970,370,10,360],[2010,370,10,350],[1860,720,30,10],[1860,730,10,100],[1960,730,10,110],[1930,2370,30,10],[1960,840,250,10],[2010,720,320,10],[2320,820,30,30],[2350,800,20,50],[2340,800,10,20],[2360,780,10,20],[2370,780,10,70],[2380,780,10,70],[2390,760,30,90],[2420,740,110,110],[2330,650,10,80],[2340,650,210,10],[2630,740,110,110],[2550,650,190,10],[2740,650,10,40],[2740,740,10,10],[2750,670,20,20],[2770,680,10,10],[2750,740,30,10],[2780,680,10,10],[2740,840,90,10],[2740,810,20,10],[2740,770,30,10],[2740,780,20,30],[2740,750,40,20],[2740,820,10,20],[2760,800,20,10],[2530,740,10,10],[2530,750,10,10],[2190,850,10,100],[2190,950,460,10],[2630,850,10,100],[2200,900,10,10],[2580,50,30,600],[2610,610,10,20],[2610,550,10,20],[2610,490,10,20],[2610,430,10,20],[2610,380,10,20],[2610,330,10,20],[2610,280,10,20],[2610,230,10,20],[2610,180,10,20],[2610,130,10,20],[2610,80,10,20],[2360,580,220,70],[2360,440,10,140]]);
	uncollidableObjects([[430,320,20,200],[380,360,20,120],[590,270,30,10],[590,210,30,10],[560,310,20,210],[590,150,30,10],[660,460,20,30],[770,460,10,30],[840,470,10,20],[900,440,40,50],[620,60,10,60],[920,500,10,20],[830,500,10,20],[720,500,10,20],[660,500,10,20],[770,500,10,20],[870,500,10,20],[660,60,30,50],[690,90,160,40],[830,50,10,60],[750,60,20,60],[740,120,10,380],[740,340,260,30],[980,350,10,170],[650,-70,190,10],[650,-130,10,60],[660,-130,10,10],[670,-120,10,10],[660,-110,10,10],[670,-100,10,20],[660,-80,10,10],[710,-130,10,60],[720,-130,30,10],[740,-120,10,50],[720,-80,30,10],[780,-130,10,30],[790,-100,10,10],[780,-90,10,20],[800,-90,10,20],[800,-130,10,30],[1000,470,30,20],[1040,190,10,80],[1050,220,400,10],[1380,140,70,10],[1330,80,10,290],[1240,40,10,330],[930,130,170,10],[930,80,240,10],[2310,670,280,10],[2570,540,20,130],[2020,710,310,10],[2010,680,20,10],[2020,610,10,10],[1870,580,150,10],[1880,460,10,10],[1880,460,10,10],[1880,520,10,10],[1880,390,150,10],[1570,270,210,10],[1780,280,130,10],[1910,290,60,10],[1970,300,10,10],[1980,300,10,10],[1990,310,10,20],[2000,330,10,30],[1880,350,120,10],[2030,180,0,0],[1880,350,120,10],[1570,220,10,10],[1570,160,10,10],[1570,100,10,10],[1450,80,120,10],[1340,170,30,10],[1250,170,50,10],[1270,120,60,10],[1060,170,50,20],[270,320,30,50],[260,310,50,10],[150,290,60,220],[140,270,80,20],[-280,200,310,10],[20,210,10,300],[30,220,10,10]]);

	createParticle(670,-40,"100,100,100",5,60,3,-3,1000);
	createParticle(750,-40,"100,100,100",5,60,3,-3,1000);
	createParticle(830,-40,"100,100,100",5,60,3,-3,1000);

	createParticle(-290,200,"0,0,255",3,60,5,5,1000);
	createParticle(35,220,"0,0,255",3,30,2,7,500);

	createObject(2370,550,20,30,true,"100,0,0",function() {
		for(var i in players) {
			var plr = players[i]
			plr.collidable = false;
		}
		document.body.style.backgroundColor = "rgb(100,100,100)"
	});
	//players
	createPlayer(0,-500,10,20,true,"0,0,0",{l:37,u:38,r:39},2,"1");
}

function calculateGravity(g) {
	return g+(10/60);
}
function isColliding(x,y,w,h,x2,y2,w2,h2) {
	return (x+w> x2 && x < x2+w2 && y+h > y2 && y < y2+h2)
}
function onScreen(x,y,w,h) {
	if(x+w>=0 && x <= 800 && y+h >= 0 && y <= 600) {
		return true
	}
	return false
}
function collide(plr) {
	for(var o in objects) {
		var obj = objects[o];
		if(plr.collidable) {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable == true) {
				if(obj.onTouch != undefined) {
					obj.onTouch();
				}
				return true;
			}
		} else {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable != true) {
				return true;
			}
		}
	}
	for(var p in players) {
		var pl = players[p];
		if(plr.id !== pl.id) {
			if(plr.collidable) {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable == true) {
					return true;
				}
			} else {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable != true) {
					return true;
				}
			}
		}
	}
	return false;
}
var offset = 25;
var up = true;
function logicPlayers() {
	if(up) {
		offset++;
	} else {
		offset--;
	}
	if(offset >= 50) {
		up = false;
	}
	if(offset <= 0) {
		up = true;
	}
	for(let p in players) {
		var plr = players[p];
		plr.gravity=calculateGravity(plr.gravity);
		plr.y+=plr.gravity
		if(plr.gravity >= 40) {
			location.reload();
		}
		if(collide(plr)==true) {
			plr.y-=plr.gravity
			plr.gravity = 0
		}
		if(plr.move.r) {
			plr.x+=plr.speed;
			if(collide(plr)==true) {
				plr.x-=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x+=i;
					if(collide(plr)==true)plr.x-=i;
				}
			}
		}
		if(plr.move.l) {
			plr.x-=plr.speed;
			if(collide(plr)==true) {
				plr.x+=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x-=i;
					if(collide(plr)==true)plr.x+=i;
				}
			}
		}

	}
}
var tick = 0;
function randInt(min,max) {
	return Math.random() * (max - min) + min;
}
function logicParticles() {
	for(var p in particles) {
		var particle = particles[p];
		var amtsixth = particle.amount/60;
		particle.did++;
		if(amtsixth*particle.did >= 1) {
			particle.did = 0;
			createSubParticle(particle);
		}
		if(tick == 60) {
			particle.did = 0;
		}
	}
	for(var sp in subparticles) {
		var subparticle = subparticles[sp]
		subparticle.life++;
		if(subparticle.life > subparticle.parent.life) {
			delete subparticles[sp];
		}
		subparticle.y+=subparticle.parent.speedY;
		subparticle.x+=randInt(-subparticle.parent.spreadX,subparticle.parent.spreadX);
	}

}
function drawParticles() {
	for(var sp in subparticles) {
		var subparticle = subparticles[sp];
		ctx.fillStyle = "rgb("+subparticle.parent.color+")";
		var pos = getPlayerOffset(subparticle.x,subparticle.y);
		if(onScreen(pos.x,pos.y,subparticle.parent.size,subparticle.parent.size)) {
			ctx.fillRect(pos.x,pos.y,subparticle.parent.size,subparticle.parent.size);
		}
	}
}
function loop() {
	window.requestAnimFrame(function() {
		loop();
	});

	logicPlayers();
	logicParticles();

	tick++;
	if(tick > 60) {
		tick =0;
	}
	ctx.clearRect(0,0,800,600);

	drawObjects(false);
	drawParticles();
	drawObjects(true);
	drawPlayers();
	
}

window.requestAnimFrame = (function() {
	return window.requestAnimationFrame ||
		   window.webkitRequestAnimationFrame ||
		   window.oRequestAnimationFrame ||
		   window.setTimeout(function(callback){},1000/60);
})();

createObjects();

loop();
</script></body>
</html>