<html><body style="background-color:black;user-select: none" oncontextmenu="return false;"><center><canvas id="game" width="800" height="600" style="background-color:aliceblue"></canvas><p style="color:white">Press P to add a new player. (Max of 2, first player uses arrow keys, second uses WASD. Second player optional.)</p></center><script>
players = []
objects = []
particles = []
subparticles = []
canvas = document.getElementById("game");
ctx = canvas.getContext("2d");
function createObject(x,y,w,h,collidable,color) {
	objects.push({x,y,w,h,collidable,color})
	return objects[objects.length-1]
}



function createPlayer(x,y,w,h,collidable,color,controls,speed,id) {
	players.push({x,y,w,h,collidable,color,controls,gravity:0,move:{l:false,r:false},speed,id:id})
	return players[players.length-1]
}




function createParticle(x,y,color,size,amount,spreadX,speedY,life) {
	particles.push({x,y,color,size,amount,spreadX,speedY,did:0,life});
	return particles[particles.length-1]
}
function createSubParticle(parent) {
	subparticles.push({x:(parent.x+(Math.random()+1)*5+-1),y:parent.y,life:0,parent});
	return subparticles[particles.length-1]
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION*/
function log(string) {
	console.log(string);
}
/*REMOVE THIS FUNCTION IN THE MINIFIED VERSION!*/
window.addEventListener("keydown",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=true;
			break;
		case plr.controls.l:
			plr.move.l=true;
			break;
		case plr.controls.u:
			if(playerInGround(plr)==true){plr.gravity=-5};
			break;
		}
	}
	if(k.keyCode==80) {
		var p = players[0];
		if(players.length < 2) {
			createPlayer(0,-20,p.w,p.h,p.collidable,p.color,{u:87,l:65,r:68},2,"2");
		}
	}
})
window.addEventListener("keyup",function(k) {
	for(p in players) {
		var plr = players[p];
		switch(k.keyCode) {
		case plr.controls.r:
			plr.move.r=false;
			break;
		case plr.controls.l:
			plr.move.l=false;
		}
	}
})

/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
var vec1;
var vec2;
var created = [];
canvas.addEventListener("mousedown",function(k) {
	plr = players[0]
	var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
	var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
	if(k.button == 2) {
		plr.x = x;
		plr.y = y;
		t=!t;
		log(t);
	} else {
		vec1={x,y};
	}
})
var t = false;
canvas.addEventListener("mouseup",function(k) {
	if(k.button == 0) {
		var x = Math.round(((k.clientX-canvas.offsetLeft)-((800/2-(plr.w/2))-plr.x))/10)*10;
		var y = Math.round(((k.clientY-canvas.offsetTop)-((400)-plr.y))/10)*10;
		vec2={x:x-vec1.x,y:y-vec1.y};
		var obj = "createObject(" + (vec1.x) + "," + (vec1.y) + "," + (vec2.x) + "," + (vec2.y) + ",true,\"0,0,0\")";
		if(t) {
			var obj = "createObject(" + (vec1.x) + "," + (vec1.y) + "," + (vec2.x) + "," + (vec2.y) + ",false,\"100,100,100\")";
		}
		created.push(obj);
		var createdStr = "";
		for(var i in created) {
			createdStr+=created[i] + "\n";
		}
		log(createdStr);
	}
})
/*REMOVE THIS CODE IN THE MINIFIED VERSION!*/
function playerInGround(plr) {
	plr.y+=1;
	if(collide(plr)) {
		plr.y-=1;
		return true;
	}
	return false;
}
function getPlayerOffset(posX,posY) {
	var plr = players[0];
	return {x:posX-plr.x+(800/2-(plr.w/2)),y:(posY-plr.y)+400};
}
function drawObjects(collidable) {
	for(var o in objects) {
		var obj = objects[o];
		if(obj.collidable == collidable) {
			var obj = objects[o];
			ctx.fillStyle = "rgb(" + obj.color + ")";
			var plr = players[0]
			var position = getPlayerOffset(obj.x,obj.y);
			var x = position.x;
			var y = position.y;
			if(x+obj.w >= 0 && y+obj.h >= 0 && x <= 800 && y <= 600) {
			ctx.fillRect(x,y,obj.w,obj.h);
			}
		}
	}
}
function indicator(id,posX,posY,off) {
		ctx.save();
		ctx.beginPath();
		ctx.moveTo(posX,posY-15-off);
		ctx.lineTo(posX+10,posY-15-off);
		ctx.lineTo(posX+5,posY-5-off);
		ctx.lineWidth=2;
		var clr = "rgb(120,180,140)";
		ctx.strokeStyle=clr;
		ctx.fillStyle=clr;
		ctx.fill();
		ctx.stroke();
		ctx.fillText(id,posX+3,posY-20-off)
		ctx.restore();
		//ctx.lineTo(posX+2,posY-5);
		ctx.closePath();
}
function drawPlayers() {
	var off = offset/10;
	var plr = players[0]
	ctx.fillStyle = plr.color;
	var posX = 800/2-(plr.w/2);
	var posY = 400
	ctx.fillRect(posX,posY,plr.w,plr.h);
	if(players.length > 1) {
		indicator(plr.id,posX,posY,off);
	}
	for(var p in players) {
		if(p != 0) {
			var pl = players[p];
			ctx.fillStyle = plr.color;
			var position = getPlayerOffset(pl.x,pl.y);
			var posX = position.x;
			var posY = position.y;

			ctx.fillRect(posX,posY,pl.w,pl.h);
			/*ctx.save();
			ctx.beginPath();*/
			
			indicator(pl.id,posX,posY,off)
			//I honestly don't know how this makes a triangle.
			/*ctx.moveTo(posX+10,posY-5-off);
			ctx.lineTo(posX+20,posY-5-off);
			ctx.lineTo(posX+15,posY+5-off);
			ctx.lineWidth=2;
			ctx.strokeStyle="rgb(150,180,160)";
			ctx.fillStyle="rgb(150,180,160)";
			ctx.fill();
			ctx.stroke();
			ctx.fillText(pl.id,posX+12.5,posY-10-off)
			ctx.restore();
			//ctx.lineTo(posX+2,posY-5);
			ctx.closePath();*/
		}
	}
}
function createObjects() {
	//start
	createObject(-280,150,70,420,true,"0,0,0")
	createObject(-210,440,410,130,true,"0,0,0")
	createObject(200,370,120,200,true,"0,0,0")
	createObject(370,350,40,10,true,"0,0,0")
	createObject(420,310,40,10,true,"0,0,0")
	createObject(550,310,40,10,true,"0,0,0")
	createObject(580,260,30,10,true,"0,0,0")
	createObject(580,200,20,10,true,"0,0,0")
	createObject(320,520,710,50,true,"0,0,0")
	createObject(320,400,30,155,true,"0,0,0")
	createObject(350,430,30,125,true,"0,0,0")
	createObject(380,460,30,110,true,"0,0,0")
	createObject(410,490,30,75,true,"0,0,0")
	createObject(440,520,30,50,true,"0,0,0")
	createObject(580,140,30,10,true,"0,0,0")
	createObject(640,40,280,20,true,"0,0,0")

	createObject(430,320,20,200,false,"100,100,100")
	createObject(380,360,20,120,false,"100,100,100")
	createObject(590,270,30,10,false,"100,100,100")
	createObject(590,210,30,10,false,"100,100,100")
	createObject(560,310,20,210,false,"100,100,100")
	createObject(590,150,30,10,false,"100,100,100")

	//factory
	createObject(620,40,20,20,true,"0,0,0")
	createObject(620,120,20,450,true,"0,0,0")
	createObject(660,-70,30,120,true,"0,0,0")
	createObject(740,-70,30,120,true,"0,0,0")
	createObject(820,-70,30,120,true,"0,0,0")

	createObject(620,60,10,60,false,"100,100,100")
	createParticle(670,-40,"100,100,100",5,200,3,-3,1000);
	createParticle(750,-40,"100,100,100",5,200,3,-3,1000);
	createParticle(830,-40,"100,100,100",5,200,3,-3,1000);
	//players
	createPlayer(0,0,10,20,true,"255,255,255",{l:37,u:38,r:39},2,"1");
}
function calculateGravity(g) {
	return g+(10/60);
}
function isColliding(x,y,w,h,x2,y2,w2,h2) {
	return (x+w> x2 && x < x2+w2 && y+h > y2 && y < y2+h2)
}
function collide(plr) {
	for(var o in objects) {
		var obj = objects[o];
		if(plr.collidable) {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable == true) {
				return true;
			}
		} else {
			if(isColliding(plr.x,plr.y,plr.w,plr.h,obj.x,obj.y,obj.w,obj.h)==true && obj.collidable != true) {
				return true;
			}
		}
	}
	for(var p in players) {
		var pl = players[p];
		if(plr.id !== pl.id) {
			if(plr.collidable) {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable == true) {
					return true;
				}
			} else {
				if(isColliding(plr.x,plr.y,plr.w,plr.h,pl.x,pl.y,pl.w,pl.h)==true && pl.collidable != true) {
					return true;
				}
			}
		}
	}
	return false;
}
var offset = 25;
var up = true;
function logicPlayers() {
	if(up) {
		offset++;
	} else {
		offset--;
	}
	if(offset >= 50) {
		up = false;
	}
	if(offset <= 0) {
		up = true;
	}
	for(let p in players) {
		var plr = players[p];
		plr.gravity=calculateGravity(plr.gravity);
		plr.y+=plr.gravity
		if(collide(plr)==true) {
			plr.y-=plr.gravity
			plr.gravity = 0
		}
		if(plr.move.r) {
			plr.x+=plr.speed;
			if(collide(plr)==true) {
				plr.x-=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x+=i;
					if(collide(plr)==true)plr.x-=i;
				}
			}
		}
		if(plr.move.l) {
			plr.x-=plr.speed;
			if(collide(plr)==true) {
				plr.x+=plr.speed;
				for(i=0;i<plr.speed;i++) {
					plr.x-=i;
					if(collide(plr)==true)plr.x+=i;
				}
			}
		}

	}
}
var tick = 0;
function randInt(min,max) {
	return Math.random() * (max - min) + min;
}
function logicParticles() {
	for(var p in particles) {
		var particle = particles[p];
		if(particle.did < particle.amount) {
			particle.did++;
			createSubParticle(particle);
		}
		if(tick == 60) {
			particle.did = 0;
		}
	}
	for(var sp in subparticles) {
		var subparticle = subparticles[sp]
		subparticle.life++;
		if(subparticle.life > subparticle.parent.life) {
			delete subparticles[sp];
		}
		subparticle.y+=subparticle.parent.speedY;
		subparticle.x+=randInt(-subparticle.parent.spreadX,subparticle.parent.spreadX);
	}

}
function drawParticles() {
	for(var sp in subparticles) {
		var subparticle = subparticles[sp];
		ctx.fillStyle = "rgb("+subparticle.parent.color+")";
		var pos = getPlayerOffset(subparticle.x,subparticle.y);
		ctx.fillRect(pos.x,pos.y,subparticle.parent.size,subparticle.parent.size);
	}
}
function loop() {
	window.requestAnimFrame(function() {
		loop();
	});

	logicPlayers();
	logicParticles();

	tick++;
	if(tick > 60) {
		tick =0;
	}
	ctx.clearRect(0,0,800,600);

	drawObjects(false);
	drawParticles();
	drawObjects(true);
	drawPlayers();
	
}

window.requestAnimFrame = (function() {
	return window.requestAnimationFrame ||
		   window.webkitRequestAnimationFrame ||
		   window.oRequestAnimationFrame ||
		   window.setTimeout(function(callback){},1000/60);
})();

createObjects();

loop();
</script></body>
</html>